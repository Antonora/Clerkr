<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Clerkr</title>
  <style>
    :root{--b:#e7e7e7;--bg:#fff;--txt:#111;--muted:#666;--ok:#10b981;--warn:#f59e0b;--err:#b00020}
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial,sans-serif;background:#fff;color:var(--txt);max-width:980px;margin:24px auto;padding:0 12px}
    h1{margin:0 0 16px}
    .card{border:1px solid var(--b);background:#fff;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px;border:1px solid var(--b);border-radius:10px;font:inherit;background:#fff}
    button{cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.ghost{background:#fafafa}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--b);padding:10px;text-align:left;vertical-align:top}
    small{color:var(--muted)}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f3f3f3;margin-right:6px;font-size:12px}
    .pill.ok{background:#e6f7f1}
    .pill.block{background:#fff4e6}
    .danger{color:var(--err)}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .toolbar{gap:8px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid var(--b);border-radius:999px;background:#fafafa;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
  </style>
</head>
<body>
<h1>Clerkr</h1>

<!-- Skapa task -->
<div class="card">
  <h3>Ny task</h3>
  <form id="f">
  <div class="row">
    <input name="title" placeholder="Titel (obligatorisk)" required style="flex:2"/>
  </div>
  <div class="row" style="margin-top:8px">
    <textarea name="notes" rows="2" placeholder="Notes (valfritt)" style="flex:1"></textarea>
  </div>
  <div class="row" style="margin-top:10px;align-items:center">
    <button class="primary">Skapa</button>
    <span id="fmsg" class="muted"></span>
  </div>
</form>

  <small class="muted">AI fyller p√• impact/estimate/blocking/deadline automatiskt strax efter skapad task.</small>
</div>

<!-- Tasklista -->
<div class="card">
  <div class="row toolbar">
    <h3 style="margin:0">Tasks</h3>
    <div class="tabs" id="tabs">
      <div class="tab active" data-status="all">Alla</div>
      <div class="tab" data-status="todo">Todo</div>
      <div class="tab" data-status="doing">Doing</div>
      <div class="tab" data-status="blocked">Blocked</div>
      <div class="tab" data-status="done">Done</div>
    </div>
    <input id="search" placeholder="S√∂k titel‚Ä¶" style="flex:1;min-width:160px"/>
    <button id="refresh" class="ghost">Uppdatera</button>
  </div>
  <div id="tasks">Laddar‚Ä¶</div>
</div>

<!-- Vad nu? -->
<div class="card">
  <div class="row" style="align-items:center;justify-content:space-between">
    <h3 style="margin:0">Vad nu?</h3>
    <div id="phaseBadge" class="muted" title="Tidsguidning"></div>
  </div>
  <div class="row" style="align-items:center;margin-top:8px">
    <button id="what" class="primary">K√∂r prioritering</button>
    <span id="wnmsg" class="muted"></span>
  </div>
  <div id="wn" style="margin-top:12px"></div>
</div>

<!-- Chat -->
<div class="card">
  <h3 style="margin:0 0 8px 0">Chat</h3>
  <div id="chat" style="border:1px solid #eee;border-radius:10px;padding:12px;height:260px;overflow:auto;background:#fff"></div>
  <div class="row" style="margin-top:8px;align-items:center">
    <input id="chatInput" placeholder="S√§g vad du beh√∂ver‚Ä¶" style="flex:1"/>
    <button id="micBtn" class="ghost" title="Tala">üé§</button>
    <button id="sendBtn" class="primary">Skicka</button>
  </div>
  <small class="muted">Tips: S√§g t.ex. ‚Äúl√§gg till ‚Äòmaila Electrolux om royalty‚Äô med not ‚Äòf√∂re fredag‚Äô‚Äù.</small>
</div>

<div id="toast" class="toast"></div>

<script>
const api = (p, opt={}) => fetch(p, opt).then(async r=>{
  let j; try{ j = await r.json(); }catch{ j = { error: 'Ogiltigt svar'} }
  if(!r.ok) throw new Error(j.error || r.statusText);
  return j;
});

const fmtDate = iso => iso ? new Date(iso).toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',year:'numeric',month:'short',day:'2-digit'}) : '';

let cache = { items: [] };
let currentStatus = 'all';
let currentQuery = '';

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2000);
}

function renderTasks(){
  const el = document.getElementById('tasks');
  let items = cache.items || [];
  if(currentStatus !== 'all') items = items.filter(t => t.status === currentStatus);
  if(currentQuery.trim()) {
    const q = currentQuery.toLowerCase();
    items = items.filter(t => (t.title||'').toLowerCase().includes(q));
  }
  if(!items.length){ el.innerHTML = '<div class="muted">Inga tasks matchar filtret.</div>'; return; }

  const rows = items.map(t=>`
    <tr data-id="${t.id}">
      <td>
        <div><b>${t.title}</b></div>
        ${t.ai_reason ? `<div><small class="muted">AI: ${t.ai_reason}</small></div>`:''}
        ${t.blocking ? `<span class="pill block">Blocking</span>`:''}
      </td>
      <td>${t.estimate_min ?? ''}</td>
      <td>${t.impact ?? ''}</td>
      <td>${fmtDate(t.deadline_at)}</td>
      <td><span class="pill">${t.status}</span></td>
      <td class="actions">
        ${t.status!=='done' ? `<button data-action="done">‚úì Klar</button>`:''}
        ${t.status!=='doing' ? `<button data-action="doing">Starta</button>`:''}
        ${t.status!=='blocked' ? `<button data-action="blocked">Blockerad</button>`:''}
        ${t.status!=='todo' ? `<button data-action="todo">Tillbaka</button>`:''}
      </td>
    </tr>
  `).join('');
  el.innerHTML = `
    <table>
      <thead>
        <tr><th>Titel</th><th>Est</th><th>Impact</th><th>Deadline</th><th>Status</th><th>√Ötg√§rd</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  // Action-knappar
el.querySelectorAll('button[data-action]').forEach(btn=>{
  btn.onclick = async ()=>{
    const tr = btn.closest('tr');
    const id = tr.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    const label = btn.textContent;

    btn.disabled = true; btn.textContent = '...';
    try{
      if (action === 'done') {
        await api('/api/delete-task', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id })
        });
        // Ta bort raden lokalt ‚Äì permanent
        cache.items = (cache.items||[]).filter(x => x.id !== id);
        renderTasks();
        toast('Borttagen ‚úÖ');
      } else {
        await api('/api/update-task', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, status: action })
        });
        toast(`Uppdaterad: ${label}`);
        await loadTasks(true);
      }
    }catch(e){
      alert('Kunde inte utf√∂ra √•tg√§rd: ' + e.message);
    }finally{
      btn.disabled = false;
    }
  };
});

}

async function loadTasks(silent=false){
  const el = document.getElementById('tasks');
  if(!silent) el.textContent = 'Laddar‚Ä¶';
  try{
    const r = await api('/api/tasks'); // GET fr√•n din api/tasks.ts
    cache.items = r.items || [];
    renderTasks();
  }catch(e){
    el.innerHTML = `<div class="danger">${e.message}</div>`;
  }
}

document.getElementById('refresh').onclick = ()=>loadTasks();
document.getElementById('tabs').onclick = (ev)=>{
  const t = ev.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  t.classList.add('active');
  currentStatus = t.getAttribute('data-status');
  renderTasks();
};
document.getElementById('search').oninput = (ev)=>{ currentQuery = ev.target.value || ''; renderTasks(); };

document.getElementById('f').onsubmit = async (ev) => {
  ev.preventDefault();

  const fd = new FormData(ev.target);
  const body = {
    title: fd.get('title'),
    notes: fd.get('notes') || null
  };

  const msg = document.getElementById('fmsg');
  msg.textContent = 'Skickar‚Ä¶';

  try {
    await api('/api/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    msg.textContent = 'Skapad ‚úÖ';
    ev.target.reset();
    await loadTasks(true); // uppdatera direkt ‚Äì AI klart p√• servern
  } catch (e) {
    msg.textContent = e.message;
    msg.className = 'danger';
  }
};



document.getElementById('what').onclick = async ()=>{
  const el = document.getElementById('wn');
  const msg = document.getElementById('wnmsg');
  el.textContent = '';
  msg.textContent = 'Prioriterar‚Ä¶';
  try{
    const r = await api('/api/what-now', { method:'POST' }); // din handler kr√§ver POST
    const p = r.primary_task || {};
    const alts = (r.alternatives||[]).map(a=>`<li>${a.title} (${a.duration_min} min)</li>`).join('');
    el.innerHTML = `
      <div class="card" style="border-color:#ddd">
        <div><b>Huvuduppgift:</b> ${p.title || ''} ${p.duration_min? `(${p.duration_min} min)`:''}</div>
        ${p.why? `<div><small class="muted">${p.why}</small></div>`:''}
        ${alts? `<div style="margin-top:8px"><b>Alternativ:</b><ul>${alts}</ul></div>`:''}
        ${r.next_step ? `<div style="margin-top:8px"><b>N√§sta steg:</b> ${r.next_step.action}${r.next_step.details? ' ‚Äî '+r.next_step.details:''}</div>`:''}
      </div>
    `;
    msg.textContent = '';
  }catch(e){
    el.innerHTML = `<div class="danger">${e.message}</div>`;
    msg.textContent = '';
  }
};
function getPhaseNowStockholm(){
  // ber√§kna timme i Europe/Stockholm oavsett anv√§ndarens lokala TZ
  const fmt = new Intl.DateTimeFormat('sv-SE', { timeZone:'Europe/Stockholm', hour:'2-digit', hour12:false, weekday:'short' });
  const parts = fmt.formatToParts(new Date());
  const hour = Number(parts.find(p=>p.type==='hour')?.value || '0');
  const weekdayShort = parts.find(p=>p.type==='weekday')?.value || 'm√•n';

  // 0=s√∂n i JS, men h√§r k√∂r vi enkel vardag/helg via svensk f√∂rkortning
  const helg = ['l√∂r','s√∂n'].includes(weekdayShort.toLowerCase());

  let phase = 'morning';
  if (hour >= 12 && hour < 17) phase = 'afternoon';
  else if (hour >= 17 || hour < 6) phase = 'evening';

  return { hour, weekdayShort, isWeekend: helg, phase };
}

function renderPhaseBadge(){
  const el = document.getElementById('phaseBadge');
  if (!el) return;
  const { hour, weekdayShort, isWeekend, phase } = getPhaseNowStockholm();
  const phaseSv = phase === 'morning' ? 'morgon' : (phase === 'afternoon' ? 'eftermiddag' : 'kv√§ll');
  el.textContent = `${isWeekend ? 'helg' : 'vardag'} ¬∑ ${weekdayShort} ¬∑ ${phaseSv} (${String(hour).padStart(2,'0')}:00)`;
}

<script>
/* ===== Chat helpers ===== */
const chatEl = document.getElementById('chat');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

let chatHistory = []; // [{role:'user'|'assistant', content:'...'}]

function renderChat() {
  chatEl.innerHTML = chatHistory.map((m, idx) => {
    const isAssistant = m.role === 'assistant';
    const contentHtml = escapeHtml(m.content).replace(/\n/g, '<br/>');

    return `
      <div style="margin:6px 0; display:flex; ${m.role==='user'?'justify-content:flex-end':''}">
        <div style="max-width:80%; padding:8px 10px; border:1px solid #eee; border-radius:10px; background:${m.role==='user'?'#111':'#fafafa'}; color:${m.role==='user'?'#fff':'#111'}">
          <div class="msg" data-idx="${idx}">${contentHtml}</div>
          ${isAssistant ? `
            <div style="margin-top:6px; display:flex; gap:6px">
              <button class="ghost" data-add-from="bubble" data-idx="${idx}" title="Skapa task av detta">‚ûï Skapa task</button>
            </div>
          ` : ``}
        </div>
      </div>
    `;
  }).join('');
  chatEl.scrollTop = chatEl.scrollHeight;

  // Wire up "Skapa task"-knappar
  chatEl.querySelectorAll('button[data-add-from]').forEach(btn => {
    btn.onclick = async () => {
      const idx = Number(btn.getAttribute('data-idx'));
      const raw = chatHistory[idx]?.content || '';
      const title = inferTitleFromText(raw);
      const sel = getSelectionTextIn(chatEl); // om du markerat text i bubblan
      const useTitle = (sel && sel.trim()) || title;

      const finalTitle = prompt('Titel f√∂r task:', useTitle || '');
      if (!finalTitle || !finalTitle.trim()) return;

      const notes = prompt('Notes (valfritt):', '');
      try {
        await api('/api/tasks', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title: finalTitle.trim(), notes: notes || null })
        });
        toast('Task skapad ‚úÖ');
        await loadTasks(true);
      } catch (e) {
        alert('Kunde inte skapa task: ' + e.message);
      }
    };
  });
}

// Hj√§lper: extrahera rimlig titel ur assistenttext
function inferTitleFromText(text='') {
  // 1) Om svar inneh√•ller punktlista ‚Üí ta f√∂rsta punkten
  const bullet = text.match(/^[\-\‚Ä¢\*]\s*(.+)$/m);
  if (bullet && bullet[1]) return bullet[1].trim();

  // 2) Plocka f√∂rsta raden/meningen
  const line = text.split('\n').map(s => s.trim()).find(Boolean) || text.trim();
  const sentence = (line.split(/(?<=\.)\s|(?<!\w)\n/)[0] || line).trim();

  // 3) Rensa prefix typ ‚ÄúHuvuduppgift:‚Äù
  return sentence
    .replace(/^Huvuduppgift:\s*/i, '')
    .replace(/^G√∂r s√• h√§r:\s*/i, '')
    .replace(/^Next:\s*/i, '')
    .replace(/^F√∂rslag:\s*/i, '')
    .slice(0, 120);
}

// Hj√§lper: text du markerat i chatten (om n√•gon)
function getSelectionTextIn(container) {
  const sel = window.getSelection && window.getSelection();
  if (!sel || sel.rangeCount === 0) return '';
  const range = sel.getRangeAt(0);
  if (!container.contains(range.commonAncestorContainer)) return '';
  return sel.toString();
}
function escapeHtml(s=''){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

async function sendChat() {
  const text = (chatInput.value || '').trim();
  if (!text) return;
  chatInput.value = '';

  chatHistory.push({ role: 'user', content: text });
  renderChat();

  try {
    const r = await api('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ messages: chatHistory })
    });
    const reply = r.reply || 'Ok.';
    chatHistory.push({ role: 'assistant', content: reply });
    renderChat();

    // Kolla om svaret inneh√•ller <ADD_TASK>{...}</ADD_TASK>
    const added = await maybeAddTaskFromReply(reply);
    if (added) {
      toast('Task skapad via chat ‚úÖ');
      await loadTasks(true);
    }
  } catch (e) {
    chatHistory.push({ role: 'assistant', content: 'Kunde inte svara just nu.' });
    renderChat();
  }
}

async function maybeAddTaskFromReply(reply) {
  const m = reply.match(/<ADD_TASK>([\s\S]*?)<\/ADD_TASK>/);
  if (!m) return false;
  try {
    const obj = JSON.parse(m[1]);
    if (!obj || !obj.title) return false;
    await api('/api/tasks', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ title: obj.title, notes: obj.notes || null })
    });
    return true;
  } catch(_e) {
    console.warn('ADD_TASK parse failed', _e);
    return false;
  }
}

// Wire-up
sendBtn.onclick = sendChat;
chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

  /* ===== Speech-to-text (MVP via Web Speech API) ===== */
  let recognizer = null;
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognizer = new SR();
    recognizer.lang = 'sv-SE';
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;

    recognizer.onresult = (e) => {
      const text = e.results?.[0]?.[0]?.transcript || '';
      if (text) { chatInput.value = text; chatInput.focus(); }
      micBtn.textContent = 'üé§';
    };
    recognizer.onstart = ()=> { micBtn.textContent = '‚ñ†'; };
    recognizer.onend = ()=> { micBtn.textContent = 'üé§'; };
    recognizer.onerror = ()=> { micBtn.textContent = 'üé§'; toast('Mikrofonfel'); };
    micBtn.onclick = ()=> { try { recognizer.start(); } catch {} };
  } else {
    micBtn.disabled = true;
    micBtn.title = 'Inte st√∂dd i denna browser';
  }

  // ===== init =====
  loadTasks();
  renderPhaseBadge();
  setInterval(renderPhaseBadge, 60 * 1000);

  chatHistory.push({
    role: 'assistant',
    content: 'Hej! S√§g vad du beh√∂ver. L√§gg till uppgifter genom att skriva "l√§gg till ‚Ä¶".'
  });
  renderChat();
  
  
</script>
<script id="minidebug">
(function(){
  try {
    // Panel
    var box = document.createElement('div');
    box.id = 'debugBox';
    box.style.cssText = 'position:fixed;left:8px;right:8px;bottom:8px;max-height:40vh;overflow:auto;background:#000;color:#0f0;font:12px/1.4 ui-monospace,monospace;padding:8px;border-radius:8px;opacity:.92;z-index:2147483647;display:block;box-shadow:0 4px 16px rgba(0,0,0,.3)';
    box.innerHTML = '[MiniDebug] startar‚Ä¶<br/>';
    document.body.appendChild(box);

    // Toggle-knapp
    var btn = document.createElement('button');
    btn.textContent = 'üêû';
    btn.title = 'Visa/D√∂lj debug';
    btn.style.cssText = 'position:fixed;right:8px;bottom:8px;width:42px;height:42px;border-radius:50%;border:1px solid #ccc;background:#fff;z-index:2147483647';
    btn.onclick = function(){
      box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    };
    document.body.appendChild(btn);

    function fmtArg(a){
      if (a instanceof Error) return a.stack || a.message;
      if (typeof a === 'object') { try { return JSON.stringify(a); } catch { return String(a); } }
      return String(a);
    }
    function logLine(type, args){
      var d = new Date().toLocaleTimeString();
      box.innerHTML += '['+d+'] '+type+': '+args.map(fmtArg).join(' ')+'<br/>';
      box.scrollTop = box.scrollHeight;
    }

    // Exponera helpers globalt
    window.__debugShow = function(on){ box.style.display = on ? 'block' : 'none'; };
    window.__debugClear = function(){ box.innerHTML = ''; };

    // Hooka console + globala fel
    var origLog = console.log.bind(console);
    var origErr = console.error.bind(console);
    console.log = function(){ origLog.apply(console, arguments); logLine('LOG', Array.from(arguments)); };
    console.error = function(){ origErr.apply(console, arguments); logLine('ERR', Array.from(arguments)); };
    window.addEventListener('error', function(e){ logLine('ONERROR', [e.message]); });
    window.addEventListener('unhandledrejection', function(e){
      var r = e.reason;
      logLine('REJECT', [r && (r.message || r.stack || String(r))]);
    });

    console.log('MiniDebug redo');
  } catch (e) {
    // Sista utv√§g p√• mobil: visa ett alert
    alert('MiniDebug failed: ' + (e && e.message));
  }
})();
</script>
</body>
</html>