<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Clerkr</title>
  <style>
    :root{--b:#e7e7e7;--bg:#fff;--txt:#111;--muted:#666;--ok:#10b981;--warn:#f59e0b;--err:#b00020}
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial,sans-serif;background:#fff;color:var(--txt);max-width:980px;margin:24px auto;padding:0 12px}
    h1{margin:0 0 16px}
    .card{border:1px solid var(--b);background:#fff;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px;border:1px solid var(--b);border-radius:10px;font:inherit;background:#fff}
    button{cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.ghost{background:#fafafa}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--b);padding:10px;text-align:left;vertical-align:top}
    small{color:var(--muted)}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f3f3f3;margin-right:6px;font-size:12px}
    .pill.ok{background:#e6f7f1}
    .pill.block{background:#fff4e6}
    .danger{color:var(--err)}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .toolbar{gap:8px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid var(--b);border-radius:999px;background:#fafafa;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
  </style>
</head>
<body>
<h1>Clerkr</h1>

<!-- Skapa task -->
<div class="card">
  <h3>Ny task</h3>
  <form id="f">
  <div class="row">
    <input name="title" placeholder="Titel (obligatorisk)" required style="flex:2"/>
  </div>
  <div class="row" style="margin-top:8px">
    <textarea name="notes" rows="2" placeholder="Notes (valfritt)" style="flex:1"></textarea>
  </div>
  <div class="row" style="margin-top:10px;align-items:center">
    <button class="primary">Skapa</button>
    <span id="fmsg" class="muted"></span>
  </div>
</form>

  <small class="muted">AI fyller på impact/estimate/blocking/deadline automatiskt strax efter skapad task.</small>
</div>

<!-- Tasklista -->
<div class="card">
  <div class="row toolbar">
    <h3 style="margin:0">Tasks</h3>
    <div class="tabs" id="tabs">
      <div class="tab active" data-status="all">Alla</div>
      <div class="tab" data-status="todo">Todo</div>
      <div class="tab" data-status="doing">Doing</div>
      <div class="tab" data-status="blocked">Blocked</div>
      <div class="tab" data-status="done">Done</div>
    </div>
    <input id="search" placeholder="Sök titel…" style="flex:1;min-width:160px"/>
    <button id="refresh" class="ghost">Uppdatera</button>
  </div>
  <div id="tasks">Laddar…</div>
</div>

<!-- Vad nu? -->
<div class="card">
  <h3>Vad nu?</h3>
  <div class="row" style="align-items:center">
    <button id="what" class="primary">Kör prioritering</button>
    <span id="wnmsg" class="muted"></span>
  </div>
  <div id="wn" style="margin-top:12px"></div>
</div>

<div id="toast" class="toast"></div>

<script>
const api = (p, opt={}) => fetch(p, opt).then(async r=>{
  let j; try{ j = await r.json(); }catch{ j = { error: 'Ogiltigt svar'} }
  if(!r.ok) throw new Error(j.error || r.statusText);
  return j;
});

const fmtDate = iso => iso ? new Date(iso).toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',year:'numeric',month:'short',day:'2-digit'}) : '';

let cache = { items: [] };
let currentStatus = 'all';
let currentQuery = '';

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2000);
}

function renderTasks(){
  const el = document.getElementById('tasks');
  let items = cache.items || [];
  if(currentStatus !== 'all') items = items.filter(t => t.status === currentStatus);
  if(currentQuery.trim()) {
    const q = currentQuery.toLowerCase();
    items = items.filter(t => (t.title||'').toLowerCase().includes(q));
  }
  if(!items.length){ el.innerHTML = '<div class="muted">Inga tasks matchar filtret.</div>'; return; }

  const rows = items.map(t=>`
    <tr data-id="${t.id}">
      <td>
        <div><b>${t.title}</b></div>
        ${t.ai_reason ? `<div><small class="muted">AI: ${t.ai_reason}</small></div>`:''}
        ${t.blocking ? `<span class="pill block">Blocking</span>`:''}
      </td>
      <td>${t.estimate_min ?? ''}</td>
      <td>${t.impact ?? ''}</td>
      <td>${fmtDate(t.deadline_at)}</td>
      <td><span class="pill">${t.status}</span></td>
      <td class="actions">
        ${t.status!=='done' ? `<button data-action="done">✓ Klar</button>`:''}
        ${t.status!=='doing' ? `<button data-action="doing">Starta</button>`:''}
        ${t.status!=='blocked' ? `<button data-action="blocked">Blockerad</button>`:''}
        ${t.status!=='todo' ? `<button data-action="todo">Tillbaka</button>`:''}
      </td>
    </tr>
  `).join('');
  el.innerHTML = `
    <table>
      <thead>
        <tr><th>Titel</th><th>Est</th><th>Impact</th><th>Deadline</th><th>Status</th><th>Åtgärd</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  // Action-knappar
  el.querySelectorAll('button[data-action]').forEach(btn=>{
   btn.onclick = async ()=>{
  const tr = btn.closest('tr');
  const id = tr.getAttribute('data-id');
  const status = btn.getAttribute('data-action');
  const label = btn.textContent;
  btn.disabled = true; btn.textContent = '...';
  try{
    await api('/api/update-task', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id, status })
    });
    // Optimistiskt: ta bort raden om done
    if(status === 'done'){
      cache.items = (cache.items||[]).filter(x => x.id !== id);
      renderTasks();
    } else {
      await loadTasks(true);
    }
  }catch(e){
    alert('Kunde inte uppdatera: ' + e.message);
  }finally{
    btn.disabled = false;
  }
};

  });
}

async function loadTasks(silent=false){
  const el = document.getElementById('tasks');
  if(!silent) el.textContent = 'Laddar…';
  try{
    const r = await api('/api/tasks'); // GET från din api/tasks.ts
    cache.items = r.items || [];
    renderTasks();
  }catch(e){
    el.innerHTML = `<div class="danger">${e.message}</div>`;
  }
}

document.getElementById('refresh').onclick = ()=>loadTasks();
document.getElementById('tabs').onclick = (ev)=>{
  const t = ev.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  t.classList.add('active');
  currentStatus = t.getAttribute('data-status');
  renderTasks();
};
document.getElementById('search').oninput = (ev)=>{ currentQuery = ev.target.value || ''; renderTasks(); };

document.getElementById('f').onsubmit = async (ev)=>{
  ev.preventDefault();
  const fd = new FormData(ev.target);
  const body = {
  title: fd.get('title'),
  notes: fd.get('notes') || null
};
await api('/api/tasks', {
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body: JSON.stringify(body)
});

    msg.textContent = 'Skapad ✅ (AI berikar strax)';
    ev.target.reset();
    setTimeout(()=>loadTasks(true), 1200); // ge classify-task lite tid
  }catch(e){
    msg.textContent = e.message; msg.className='danger';
  }
};

document.getElementById('what').onclick = async ()=>{
  const el = document.getElementById('wn');
  const msg = document.getElementById('wnmsg');
  el.textContent = '';
  msg.textContent = 'Prioriterar…';
  try{
    const r = await api('/api/what-now', { method:'POST' }); // din handler kräver POST
    const p = r.primary_task || {};
    const alts = (r.alternatives||[]).map(a=>`<li>${a.title} (${a.duration_min} min)</li>`).join('');
    el.innerHTML = `
      <div class="card" style="border-color:#ddd">
        <div><b>Huvuduppgift:</b> ${p.title || ''} ${p.duration_min? `(${p.duration_min} min)`:''}</div>
        ${p.why? `<div><small class="muted">${p.why}</small></div>`:''}
        ${alts? `<div style="margin-top:8px"><b>Alternativ:</b><ul>${alts}</ul></div>`:''}
        ${r.next_step ? `<div style="margin-top:8px"><b>Nästa steg:</b> ${r.next_step.action}${r.next_step.details? ' — '+r.next_step.details:''}</div>`:''}
      </div>
    `;
    msg.textContent = '';
  }catch(e){
    el.innerHTML = `<div class="danger">${e.message}</div>`;
    msg.textContent = '';
  }
};

// init
loadTasks();
</script>
</body>
</html>
